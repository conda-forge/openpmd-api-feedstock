From 0f6f814fa67b1436b22119708d6afc55d8fe237b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Franz=20P=C3=B6schel?= <franz.poeschel@gmail.com>
Date: Fri, 31 Mar 2023 13:04:04 +0200
Subject: [PATCH] Instantiate only parallel ADIOS1 IO Handler in parallel
 ADIOS1 lib

---
 src/IO/ADIOS/CommonADIOS1IOHandler.cpp | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/IO/ADIOS/CommonADIOS1IOHandler.cpp b/src/IO/ADIOS/CommonADIOS1IOHandler.cpp
index 98e14f020..e5e32d2dc 100644
--- a/src/IO/ADIOS/CommonADIOS1IOHandler.cpp
+++ b/src/IO/ADIOS/CommonADIOS1IOHandler.cpp
@@ -2035,9 +2035,19 @@ void CommonADIOS1IOHandlerImpl<ChildClass>::initJson(json::TracingJSON config)
     }
 }
 
-template class CommonADIOS1IOHandlerImpl<ADIOS1IOHandlerImpl>;
+/*
+ * Sic!
+ * The ADIOS1 IO Handler is built as two CMake targets: serial and parallel.
+ * One receives the definition openPMD_HAVE_MPI=0, the other receives
+ * openPMD_HAVE_MPI=1.
+ * So, if openPMD_HAVE_MPI is true, then we do not need to instantiate both
+ * the serial and the parallel handler down here, since the serial handler will
+ * be instantiated in another target.
+ */
 #if openPMD_HAVE_MPI
 template class CommonADIOS1IOHandlerImpl<ParallelADIOS1IOHandlerImpl>;
+#else
+template class CommonADIOS1IOHandlerImpl<ADIOS1IOHandlerImpl>;
 #endif // openPMD_HAVE_MPI
 
 } // namespace openPMD
